# 关于战斗

本文档介绍战斗的设计思路

## 队伍系统

一次`战斗`发生在2个`队伍`之间，目前不考虑单个hero之间的战斗。

- 一个队伍的英雄数量，目前最多是`6`个
- 队伍的英雄组成，可能构成某些`特殊光环`效果,具体可参见[英雄设计篇](./hero.md)

## 回合制

目前实现的是简单的回合制系统：

- `攻方优先`原则
    - 在所有条件均相同的情况下，攻方享有优先出手的权利
- `速度`优先原则
    - 交战双方的英雄中，速度最快的优先出手，依次排列
- 回合开始&回合结束
    - 战斗开始时，第一次出手之前，这个时机属于`回合开始`

        >部分技能、效果可能在这个阶段被触发

    - 回合开始之后，到最后一个`行动人`判定`行动完成`之后，这个时机叫做`回合结束`
        - 即使行动人由于某些情况无法做出动作，比如`眩晕`状态，也会因为触发`行动结束`事件，而导致一回合的结束

        >部分技能、效果，也可能在这个阶段被触发

- 最大回合数
    - 考虑到战斗节奏问题，回合数可能需要有限制，特别是一些Boss战之类的环境。
    - 目前初步考虑设定为`20回合`

## 关于速度和出手次数

- 1.0版本
    - 简单理解为一回合内，英雄最多出手一次。
    - 速度值只决定出手的先后顺序
- 2.0版本
    - 可以考虑实现`速度越快，出手次数越多`的效果，以体现`速度`的价值
    - 需要兼顾数值平衡的考虑

    > 实现思路：
     - 每一场战斗，对阵双方肯定有出手最快的，和出手最慢的人
     - 作为战斗旁观者，其实关心的是他们的相对出手速度
     - 假设最快的人速度是100，最慢的是50，那么：
        - 战斗开始时，按照速度`最低值`初始化每个英雄的`行动力`(A:50 B:50)
        - 英雄的每次行动判定，在tick时进行判断.
        - 英雄行动完成之后，需要扣除`行动基准点数`（这个点数=速度最低值）(A:50->0  B:50->0)
        - 所有英雄都(无法行动)之后，进入时间流式状态，按照速度值，恢复行动点数(A:0->100 B:0->50)
        - 再次行动之后，A剩余50而B剩余0，所以A此时可以再次行动

## 浮动怒气系统

怒气达到MAX,会自动释放主动技能。

1.0实现的是一种新型的`浮动怒气系统`。考虑到更契合实际中的不同性格的角色。

- 怒气上限多，释放技能慢，但是技能效果(和怒气值相关)越强，可以实现一些类似秒杀的效果
- 怒气上限少，释放技能快且频繁。但是技能效果可能会比较弱

    > 当然如果有一些技能效果是和怒气值无关的固定值，那肯定适合用于一些怒气上限较小的英雄身上。

    > 为了反制这种利用频繁放技能来获取优势的可能性，技能设计方面可以进行平衡。比如"针对受到技能效果进行反噬"类的技能

需要注意的是，怒气满之后，释放技能需要人物状态的支持，不能是如`眩晕`，`沉默`等状态

## 物理&魔法并存的攻防体系
本系统中，普通攻击、技能等行为，都具有所属`类别`的概念，分`物理`和`魔法`两种。

- 在计算`物理`类行为的伤害值时，只看双方的`物理攻击力`、`物理防御力`等数值
- 在计算`魔法`类行为的伤害值时，只看双方的`魔法攻击力`、`魔法防御力`等数值
- 部分技能效果，比如`免除所有伤害`，可以无视此类分类

## 战场的位置

战场的位置暂时分3排，每排2人，位置如下图例:

> 位置从前排往后依次`1~6`

进|攻|方|<->|防|守|方
-----|----|----|----|----|----|----
5|3|1|<->|1|3|5
6|4|2|<->|2|4|6

## 详细战斗流程

这里涉及一些概念，可以参考:

- [Action](./action.md)
- [Mutation](./mutation.md)


序号|过程控制者|过程名|过程输入|过程逻辑|过程输出
---|--------|-----|-------|------|--------
00|Battle|战斗开始|无|触发生命周期|无
00|Battle|回合开始|无|触发生命周期|无
01|Battle|确定行动单位|无|以`SPD`为依据，选出最先行动的单位|Hero(行动人)
02|Hero|判断行动类型|怒气值、hero effect列表|1.如果状态允许（非眩晕、沉默等），且怒气满，则放主动技能 2.如果怒气不满，则普攻。3.如果无法行动(眩晕，冰冻，则跳过此轮)|行动类型
03|Hero|开始行动|无|触发生命周期|无
04|Hero|普通攻击|英雄skill列表第一个(默认未普通攻击技能)|解析skill效果，进行target选择，对每个target进行installEffect|无
05|Hero|释放技能|英雄skill列表第二个(默认为主动技能)|解析skill效果，进行target选择，对每个target进行installEffect|无
06|Hero|结束行动|无|触发生命周期|无
07|Battle|下一步策略判定|无|判断是否回合结束|是否回合结束
08|Battle|回合结束|无|如果回合结束，则触发生命周期|无
01|Battle|确定下1个行动单位|无|跳转到01步骤，如此循环|Hero(行动人)
..|..|..|..|..|..
09|Battle|战斗结束|无|如果一方获胜，则触发生命周期|无
